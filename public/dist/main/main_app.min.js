angular.module("account",["util.http"]),angular.module("account").service("accountService",["httpService",function(a){var b=this;b.createAccount=function(b){return a.post({url:window.location.origin+"/users",data:b})}}]),angular.module("call",["user","connection","util.pubsub","util.location","tasks"]),angular.module("call").controller("CallCtrl",["$scope","$log","$stateParams","callService","userService",function(a,b,c,d,e){b.info("CallCtrl initialized... callId: "+c.callId),a.callId=c.callId,a.muteState="mute",a.answer=function(){b.info("answer is clicked "),d.answer({callId:c.callId}),$("#incomingCallModal").modal("hide")},a.end=function(){b.info("decline is clicked "),d.end({callId:c.callId}),$("#incomingCallModal").modal("hide")},a.mute=function(){b.info("mute is clicked : "+a.muteState),d.mute({callId:c.callId,mute:"mute"!==a.muteState}),"mute"===a.muteState?a.muteState="unmute":a.muteState="mute"},d.onLocalStreamAdded=function(a){b.info("local stream added: ",a),angular.element("#localStream")[0].srcObject=a},d.onRemoteStreamAdded=function(a){b.info("remote stream added: ",a),angular.element("#remoteStream")[0].srcObject=a},d.isIncomingCall({callId:c.callId})&&$("#incomingCallModal").modal(),a.$on("$destroy",function(){$("#incomingCallModal").remove(),$(".modal-backdrop").remove()})}]),angular.module("call").service("callFSM",["$log","$q","pubsub","pubsubSubscriber","pubsubEvent","pubsubMethods","taskFactory","callFsmTasks",function(a,b,c,d,e,f,g,h){function i(a){var b,e,f,h,i,l,m,n;a.msg.callId?i=a.msg.callId:(i=UUID.generate(),a.msg.callId=i),j[i]||(j[i]={trIndex:0,transition:k[a.event]}),h=j[i],l=h.transition[h.trIndex].when;for(b in l)if(l.hasOwnProperty(b)&&l[b].event===a.event){m=l[b].performs;for(var e in m)if(m.hasOwnProperty(e)){n=g[m[e]];for(var f in n.params)n.params.hasOwnProperty(f)&&(a.msg[f]=n.params[f]);c[n.pubsubMethod]({publisher:d.call_fsm,subscriber:n.subscriber,event:n.event,msg:a.msg})}}h.transition[h.trIndex].loop||h.trIndex++}var j={},k={};k[e.start_call_gui]={},k[e.start_call_gui][0]={when:[{event:e.start_call_gui,performs:[h.publish_create_outgoing_call,h.publish_location_change_to_call,h.publish_request_media_permission]}]},k[e.start_call_gui][1]={when:[{event:e.media_permission_rejected,performs:[h.broadcast_clear_resources]},{event:e.media_permission_granted,performs:[h.publish_create_peer]}]},k[e.start_call_gui][2]={when:[{event:e.create_peer_completed,performs:[h.publish_create_offer]}]},k[e.start_call_gui][3]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.create_offer_failure,performs:[h.broadcast_clear_resources]},{event:e.create_offer_success,performs:[h.publish_send_start_call_request]}]},k[e.start_call_gui][4]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.send_start_call_request_failure,performs:[h.broadcast_clear_resources]},{event:e.send_start_call_request_success,performs:[]}]},k[e.start_call_gui][5]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_timeout_notify,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.call_accepted_notify,performs:[h.publish_set_local_offer]}]},k[e.start_call_gui][6]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.set_local_offer_failure,performs:[h.broadcast_clear_resources]},{event:e.set_local_offer_success,performs:[]}]},k[e.start_call_gui][7]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.call_answered_notify,performs:[h.publish_set_remote_answer]}]},k[e.start_call_gui][8]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.set_remote_answer_failure,performs:[h.broadcast_clear_resources]},{event:e.set_remote_answer_success,performs:[]}]},k[e.start_call_gui][9]={loop:!0,when:[{event:e.on_ice_connection_failed,performs:[h.broadcast_clear_resources]},{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]}]},k[e.on_incoming_call_notify]={},k[e.on_incoming_call_notify][0]={when:[{event:e.on_incoming_call_notify,performs:[h.publish_create_incoming_call,h.publish_location_change_to_call,h.publish_create_peer]}]},k[e.on_incoming_call_notify][1]={when:[,{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.create_peer_completed,performs:[]}]},k[e.on_incoming_call_notify][2]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.answer_call_gui,performs:[h.publish_send_accept_call_request]}]},k[e.on_incoming_call_notify][3]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.send_accept_call_request_failure,performs:[h.broadcast_clear_resources]},{event:e.send_accept_call_request_success,performs:[h.publish_request_media_permission]}]},k[e.on_incoming_call_notify][4]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.media_permission_rejected,performs:[h.broadcast_clear_resources]},{event:e.media_permission_granted,performs:[h.publish_add_local_stream,h.publish_set_remote_offer]}]},k[e.on_incoming_call_notify][5]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.set_remote_offer_failure,performs:[h.broadcast_clear_resources]},{event:e.set_remote_offer_success,performs:[h.publish_create_answer]}]},k[e.on_incoming_call_notify][6]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.create_answer_failure,performs:[h.broadcast_clear_resources]},{event:e.create_answer_success,performs:[h.publish_send_answer_call_request]}]},k[e.on_incoming_call_notify][7]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.send_answer_call_request_failure,performs:[h.broadcast_clear_resources]},{event:e.send_answer_call_request_success,performs:[h.publish_set_local_answer]}]},k[e.on_incoming_call_notify][8]={when:[{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]},{event:e.set_local_answer_failure,performs:[h.broadcast_clear_resources]},{event:e.set_local_answer_success,performs:[]}]},k[e.on_incoming_call_notify][9]={loop:!0,when:[{event:e.on_ice_connection_failed,performs:[h.broadcast_clear_resources]},{event:e.end_call_gui,performs:[h.broadcast_clear_resources]},{event:e.call_end_notify,performs:[h.broadcast_clear_resources]}]},c.subscribe({subscriber:d.call_fsm,callback:i}),c.subscribe({subscriber:d.global,event:e.clear_resources,callback:function(b){a.info("call fsm: deleting call object: "+b.msg.callId),delete j[b.msg.callId]}})}]).constant("callFsmTasks",{publish_create_outgoing_call:"publish_create_outgoing_call",publish_create_incoming_call:"publish_create_incoming_call",publish_state_chage:"publish_state_chage",publish_request_media_permission:"publish_request_media_permission",publish_create_peer:"publish_create_peer",publish_create_offer:"publish_create_offer",publish_create_answer:"publish_create_answer",broadcast_clear_resources:"broadcast_clear_resources",publish_send_start_call_request:"publish_send_start_call_request",publish_send_answer_call_request:"publish_send_answer_call_request",publish_send_accept_call_request:"publish_send_accept_call_request",publish_set_local_offer:"publish_set_local_offer",publish_set_local_answer:"publish_set_local_answer",publish_set_remote_offer:"publish_set_remote_offer",publish_set_remote_answer:"publish_set_remote_answer",publish_location_change_to_call:"publish_location_change_to_call",publish_add_local_stream:"publish_add_local_stream"}).run(["callFSM",function(){}]),angular.module("call").service("callService",["$log","$q","locationService","userService","httpService","httpRequestType","pubsub","pubsubSubscriber","pubsubEvent","callType",function(a,b,c,d,e,f,g,h,i,j){var k=this,l={},m={};k.onLocalStreamAdded=function(){},k.onRemoteStreamAdded=function(){},k.isIncomingCall=function(a){return l[a.callId].type===j.incoming},k.answer=function(a){g.publish({publisher:h.call_service,subscriber:h.call_fsm,event:i.answer_call_gui,msg:{callId:a.callId}})},k.end=function(a){var b=a.callId,c=l[b];e["delete"]({url:window.location.origin+"/call/"+b,data:{type:"call",action:"end",from:d.email,to:c.from,data:{msg:{callId:b}}}}),g.publish({publisher:h.call_service,subscriber:h.call_fsm,event:i.end_call_gui,msg:{callId:b}})},k.mute=function(a){g.publish({publisher:h.call_service,subscriber:h.peer_service,event:i.mute_unmute_audio,msg:{callId:a.callId,mute:a.mute}})},k.handleOnLocalStream=function(a){k.onLocalStreamAdded(a.msg.stream)},k.handleOnRemoteStream=function(a){k.onRemoteStreamAdded(a.msg.stream)},k.sendCallRequest=function(a){var b=l[a.msg.callId];return e[a.method]({url:window.location.origin+"/call/"+a.msg.callId,data:{type:a.type,action:a.action,from:d.email,to:b.from,data:{msg:a.msg}}}).then(function(b){g.publish({publisher:h.call_service,subscriber:h.call_fsm,event:a.successEvent,msg:{callId:a.msg.callId}})},function(b){g.publish({publisher:h.call_service,subscriber:h.call_fsm,event:a.failureEvent,msg:{error:b,callId:a.msg.callId}})})},k.handleSendStartCallRequest=function(a){a.method=f.post,a.type="call",a.action="start",a.successEvent=i.send_start_call_request_success,a.failureEvent=i.send_start_call_request_failure,k.sendCallRequest(a)},k.handleSendAnswerCallRequest=function(a){a.method=f.put,a.type="call",a.action="answer",a.successEvent=i.send_answer_call_request_success,a.failureEvent=i.send_answer_call_request_failure,k.sendCallRequest(a)},k.handleSendAcceptCallRequest=function(a){a.method=f.put,a.type="call",a.action="accept",a.successEvent=i.send_accept_call_request_success,a.failureEvent=i.send_accept_call_request_failure,k.sendCallRequest(a)},k.handleOnIceCandidate=function(a){var b=l[a.msg.callId];e.put({url:window.location.origin+"/call/"+a.msg.callId,data:{type:"call",action:"candidate",from:d.email,to:b.from,data:{msg:a.msg}}})},k.handleCreateCall=function(a){l[a.msg.callId]={type:a.msg.type,from:a.msg.from}},k.handleCreateOutgoingCall=function(a){a.msg.type=j.outgoing,k.handleCreateCall(a)},k.handleCreateIncomingCall=function(a){a.msg.type=j.incoming,k.handleCreateCall(a)},m[i.on_local_stream]=k.handleOnLocalStream,m[i.on_remote_stream]=k.handleOnRemoteStream,m[i.on_ice_canditate]=k.handleOnIceCandidate,m[i.send_start_call_request]=k.handleSendStartCallRequest,m[i.send_answer_call_request]=k.handleSendAnswerCallRequest,m[i.send_accept_call_request]=k.handleSendAcceptCallRequest,m[i.create_outgoing_call]=k.handleCreateOutgoingCall,m[i.create_incoming_call]=k.handleCreateIncomingCall,k.handleCallServiceEvent=function(a){m[a.event](a)},g.subscribe({subscriber:h.call_service,callback:k.handleCallServiceEvent}),g.subscribe({subscriber:h.global,event:i.clear_resources,callback:function(b){a.info("call service: deleting call object: "+b.msg.callId),delete l[b.msg.callId],c.toHome()}})}]).constant("callType",{outgoing:"outgoing",incoming:"incoming"}).run(["callService",function(){}]),angular.module("tasks",["util.pubsub"]).factory("taskFactory",["pubsubMethods","pubsubSubscriber","pubsubEvent",function(a,b,c){return{publish_location_change_to_call:{pubsubMethod:a.publish,subscriber:b.location_service,event:c.change_url_to_call},publish_create_outgoing_call:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.create_outgoing_call},publish_create_outgoing_call:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.create_outgoing_call},publish_create_incoming_call:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.create_incoming_call},publish_state_chage:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.state_change},publish_request_media_permission:{pubsubMethod:a.publish,subscriber:b.media_service,event:c.request_media_permission,params:{constraints:{audio:!0,video:!0}}},broadcast_clear_resources:{pubsubMethod:a.broadcast,subscriber:b.global,event:c.clear_resources},publish_create_peer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.create_peer},publish_create_offer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.create_offer,params:{constraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},publish_create_answer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.create_answer,params:{constraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},publish_set_local_offer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.set_local_offer},publish_set_local_answer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.set_local_answer},publish_set_remote_offer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.set_remote_offer},publish_set_remote_answer:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.set_remote_answer},publish_send_start_call_request:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.send_start_call_request},publish_send_answer_call_request:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.send_answer_call_request},publish_send_accept_call_request:{pubsubMethod:a.publish,subscriber:b.call_service,event:c.send_accept_call_request},publish_add_local_stream:{pubsubMethod:a.publish,subscriber:b.peer_service,event:c.add_local_stream}}}]),angular.module("connection",["util.http","util.location","user"]),angular.module("connection").service("connectionService",["$rootScope","$log","httpService","userService","locationService","pubsub","pubsubSubscriber","pubsubEvent",function(a,b,c,d,e,f,g,h){var i,j=this;j.openConnection=function(a){return c.post({url:window.location.origin+"/connections",data:{email:a}}).then(function(c){d.connected=!0,i=io(c.url,{query:"serverparams="+JSON.stringify({user:a,uuid:c.uuid})}),i.on("message",function(a){b.info("message received",a),"call"===a.type&&("start"===a.action?f.publish({publisher:g.connection_service,subscriber:g.call_fsm,event:h.on_incoming_call_notify,msg:{from:a.from,remoteSdp:a.data.msg.sdp,callId:a.data.msg.callId}}):"answer"===a.action?f.publish({publisher:g.connection_service,subscriber:g.call_fsm,event:h.call_answered_notify,msg:{from:a.from,sdp:a.data.msg.sdp,callId:a.data.msg.callId}}):"accept"===a.action?f.publish({publisher:g.connection_service,subscriber:g.call_fsm,event:h.call_accepted_notify,msg:{callId:a.data.msg.callId}}):"candidate"===a.action?f.publish({publisher:g.connection_service,subscriber:g.peer_service,event:h.ice_candidate_notify,msg:{candidate:a.data.msg.candidate,callId:a.data.msg.callId}}):"end"===a.action&&f.publish({publisher:g.connection_service,subscriber:g.call_fsm,event:h.call_end_notify,msg:{callId:a.data.msg.callId}}))}),i.on("disconnect",function(){i.disconnect(),i=null,d.connected=!1,e.toLogin()})})},j.sendMessage=function(){i.emit("message",{to:"test2@test.com",text:"hey you!"})}}]),angular.module("contacts",["util.http"]),angular.module("contacts").service("contactsService",["$q","httpService",function(a,b){var c,d=this;d.get=function(d){if(c){var e=a.defer();return e.resolve(c),e.promise}return b.get({url:window.location.origin+"/contacts/"+d})}}]),angular.module("home",["user","contacts","call","webrtc.mediaService","webrtc.peerService","util.pubsub","util.location"]),angular.module("home").controller("HomeCtrl",["$rootScope","$scope","$log","userService","contactsService","pubsub","pubsubSubscriber","pubsubEvent",function(a,b,c,d,e,f,g,h){c.info("HomeCtrl initialized..."),b.user=d,b.contacts=[],e.get(d.email).then(function(a){b.contacts=a}),b.startCallTo=function(a){f.publish({publisher:g.home_ctrl,subscriber:g.call_fsm,event:h.start_call_gui,msg:{from:a}})}}]),angular.module("login",["user","connection"]),angular.module("login").controller("LoginCtrl",["$scope","$log","$state","userService","connectionService",function(a,b,c,d,e){b.info("loginCtrl initialized..."),a.login=function(){b.info("loginCtrl.login clicked..."),d.email=a.email,d.password=a.password,e.openConnection(d.email).then(function(){c.go("home")})}}]),angular.module("main",["ui.router","signin","login","home","call","user","util.location"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("login",{url:"/",templateUrl:"/main/js/login/login.html",controller:"LoginCtrl"}).state("signin",{url:"/signin",templateUrl:"/main/js/signin/signin.html",controller:"SigninCtrl"}).state("home",{url:"/home",templateUrl:"/main/js/home/home.html",controller:"HomeCtrl"}).state("call",{url:"/call",params:{callId:void 0},templateUrl:"/main/js/call/call.html",controller:"CallCtrl"})}]).controller("mainCtrl",["$scope","$log",function(a,b){b.info("mainCtrl initialized...")}]).run(["$rootScope","$state","userService","locationService",function(a,b,c,d){a.$on("$stateChangeStart",function(a,b,e){"/home"!==b.url&&"/call"!==b.url||c.connected||(a.preventDefault(),d.toLogin()),"/call"!==b.url||e.callId||a.preventDefault()})}]),angular.module("signin",["user","account","connection"]),angular.module("signin").controller("SigninCtrl",["$scope","$log","$state","userService","accountService","connectionService",function(a,b,c,d,e,f){b.info("SigninCtrl initialized..."),a.createAccount=function(){b.info("SigninCtrl.createAccount clicked..."),d.email=a.email,d.password=a.password,d.firstName=a.firstName,d.lastName=a.lastName,e.createAccount(d).then(function(a){b.info("account created...",a),f.openConnection(d.email).then(function(){c.go("home")})},function(a){b.info("account create failed",a),d.password=null,d.firstName=null,d.lastName=null})}}]),angular.module("user",[]).factory("userService",[function(){var a={};return a}]),angular.module("util.http",[]).service("httpService",["$http","$q",function(a,b){var c=this;c.request=function(c){var d=b.defer();return c.headers={"Content-Type":"application/json"},a(c).then(function(a){d.resolve(a.data)},function(a){d.reject(a.data)}),d.promise},c.post=function(a){return a.method="POST",c.request(a)},c.put=function(a){return a.method="PUT",c.request(a)},c.get=function(a){return a.method="GET",c.request(a)},c["delete"]=function(a){return a.method="DELETE",c.request(a)}}]).constant("httpRequestType",{get:"get",post:"post",put:"put","delete":"delete"}),angular.module("util.location",["ui.router","util.pubsub"]).service("locationService",["$rootScope","$state","pubsub","pubsubSubscriber","pubsubEvent",function(a,b,c,d,e){function f(a){b.go(a.to,a.params)}function g(a){f({to:"call",params:{callId:a.msg.callId}})}function h(){f({to:"home"})}function i(){f({to:"login"})}var j=this,k={};j.toHome=h,j.toLogin=i,k[e.change_url_to_call]=g,c.subscribe({subscriber:d.location_service,callback:function(a){k[a.event](a)}})}]).run(["locationService",function(){}]),angular.module("util.pubsub",[]).service("pubsub",["$log","pubsubSubscriber",function(a,b){var c=this,d={};c.subscribe=function(a){return a.subscriber===b.global?(d[b.global]||(d[b.global]={}),d[b.global][a.event]||(d[b.global][a.event]=[]),void d[b.global][a.event].push(a.callback)):void(d[a.subscriber]=a.callback)},c.publish=function(b){setTimeout(function(){a.info(b.publisher+"->"+b.subscriber+": "+b.event),d[b.subscriber](b)},1)},c.broadcast=function(c){function e(a,b){setTimeout(function(){a(b)},1)}var f,g,h=d[b.global];if(h&&(g=h[c.event])){a.info("broadcasting event: "+c.event,c);for(var f in g)g.hasOwnProperty(f)&&e(g[f],c)}}}]).constant("pubsubMethods",{publish:"publish",broadcast:"broadcast"}).constant("pubsubSubscriber",{global:"global",call_fsm:"call_fsm",call_service:"call_service",media_service:"media_service",peer_service:"peer_service",connection_service:"connection_service",location_service:"location_service",home_ctrl:"home_ctrl"}).constant("pubsubEvent",{create_outgoing_call:"create_outgoing_call",create_incoming_call:"create_incoming_call",state_change:"state_change",start_call_gui:"start_call_gui",end_call_gui:"end_call_gui",answer_call_gui:"answer_call_gui",clear_resources:"clear_resources",request_media_permission:"request_media_permission",media_permission_granted:"media_permission_granted",media_permission_rejected:"media_permission_rejected",create_peer:"create_peer",create_peer_completed:"create_peer_completed",create_offer:"create_offer",create_offer_success:"create_offer_success",create_offer_failure:"create_offer_failure",create_answer:"create_answer",create_answer_success:"create_answer_success",create_answer_failure:"create_answer_failure",set_local_offer:"set_local_offer",set_local_offer_success:"set_local_offer_success",set_local_offer_failure:"set_local_offer_failure",set_local_answer:"set_local_answer",set_local_answer_success:"set_local_offer_success",set_local_answer_failure:"set_local_offer_failure",set_remote_answer:"set_remote_answer",set_remote_answer_success:"set_remote_answer_success",set_remote_answer_success:"set_remote_answer_success",set_remote_offer:"set_remote_offer",set_remote_offer_success:"set_remote_offer_success",set_remote_offer_success:"set_remote_offer_success",on_ice_canditate:"on_ice_canditate",on_ice_connection_failed:"on_ice_connection_failed",on_local_stream:"on_local_stream",on_remote_stream:"on_remote_stream",send_start_call_request:"send_start_call_request",send_start_call_request_success:"send_start_call_request_success",send_start_call_request_failure:"send_start_call_request_failure",send_answer_call_request:"send_answer_call_request",send_answer_call_request_success:"send_answer_call_request_success",send_answer_call_request_failure:"send_answer_call_request_failure",send_accept_call_request:"send_accept_call_request",send_accept_call_request_success:"send_accept_call_request_success",send_accept_call_request_failure:"send_accept_call_request_failure",call_timeout_notify:"call_timeout_notify",call_end_notify:"call_end_notify",call_accepted_notify:"call_accepted_notify",call_answered_notify:"call_answered_notify",on_incoming_call_notify:"on_incoming_call_notify",ice_candidate_notify:"ice_candidate_notify",change_url_to_call:"change_url_to_call",add_local_stream:"add_local_stream",mute_unmute_audio:"mute_unmute_audio"}),angular.module("webrtc.mediaService",["util.pubsub"]).service("mediaService",["$log","pubsub","pubsubSubscriber","pubsubEvent",function(a,b,c,d){b.subscribe({subscriber:c.media_service,event:d.request_media_permission,callback:function(a){getUserMedia(a.msg.constraints,function(e){b.publish({publisher:c.media_service,subscriber:c.call_fsm,event:d.media_permission_granted,msg:{stream:e,callId:a.msg.callId}})},function(e){b.publish({publisher:c.media_service,subscriber:c.call_fsm,event:d.media_permission_rejected,msg:{error:e,callId:a.msg.callId}})})}})}]).run(["mediaService",function(){}]),angular.module("webrtc.peerService",["util.pubsub"]).service("peerService",["$log","$q","pubsub","pubsubSubscriber","pubsubEvent",function(a,b,c,d,e){var f=this,g={},h={};f.createPeer=function(b){var f=new RTCPeerConnection({iceServers:[{url:"stun:stun.l.google.com:19302",hasCredentials:!1},{url:"stun:stun1.l.google.com:19302",hasCredentials:!1},{url:"stun:stun2.l.google.com:19302",hasCredentials:!1},{url:"stun:stun3.l.google.com:19302",hasCredentials:!1},{url:"stun:stun4.l.google.com:19302",hasCredentials:!1},{url:"stun:stun.services.mozilla.com",hasCredentials:!1}]},{mandatory:{IceTransports:"all"},optional:[{googIPv6:!0}]});return f.onaddstream=function(a){c.publish({publisher:d.peer_service,subscriber:d.call_service,event:e.on_remote_stream,msg:{callId:b.msg.callId,stream:a.stream}})},f.onicecandidate=function(a){null!==a.candidate&&c.publish({publisher:d.peer_service,subscriber:d.call_service,event:e.on_ice_canditate,msg:{callId:b.msg.callId,candidate:a.candidate}})},f.oniceconnectionstatechange=function(g){a.info("ice connection state: "+f.iceConnectionState),"failed"===f.iceConnectionState&&c.publish({publisher:d.peer_service,subscriber:d.call_fsm,event:e.on_ice_connection_failed,msg:{callId:b.msg.callId}})},f},f.handleAddLocalStream=function(a){var b=a.msg.callId,f=g[b];f.pc.addStream(a.msg.stream),c.publish({publisher:d.peer_service,subscriber:d.call_service,event:e.on_local_stream,msg:{callId:a.msg.callId,stream:a.msg.stream}})},f.handleCreatePeer=function(a){var b,h=a.msg.callId;g[h]||(g[h]={}),b=g[h],b.remoteSdp=a.msg.remoteSdp,b.pc=f.createPeer(a),a.msg.stream&&f.handleAddLocalStream(a),c.publish({publisher:d.peer_service,subscriber:d.call_fsm,event:e.create_peer_completed,msg:{callId:a.msg.callId}})},f.handleCreate=function(a){a.call.pc[a.method](function(b){a.call.localSdp=b.sdp,c.publish({publisher:d.peer_service,subscriber:d.call_fsm,event:a.successEvent,msg:{callId:a.callId,sdp:b.sdp}})},function(b){c.publish({publisher:d.peer_service,subscriber:d.call_fsm,event:a.failureEvent,msg:{callId:a.callId,error:b}})},a.constraints)},f.handleCreateOffer=function(a){var b=a.msg.callId,c=g[b];f.handleCreate({call:c,method:"createOffer",callId:a.msg.callId,constraints:a.msg.constraints,successEvent:e.create_offer_success,failureEvent:e.create_offer_failure})},f.handleCreateAnswer=function(a){var b=a.msg.callId,c=g[b];f.handleCreate({call:c,method:"createAnswer",callId:a.msg.callId,constraints:a.msg.constraints,successEvent:e.create_answer_success,failureEvent:e.create_answer_failure})},f.setDescription=function(a){var e=b.defer();return a.pc[a.method](new RTCSessionDescription({type:a.sdpType,sdp:a.sdp}),function(){e.resolve(),c.publish({publisher:d.peer_service,subscriber:d.call_fsm,event:a.successEvent,msg:{callId:a.callId}})},function(b){e.reject(),c.publish({publisher:d.peer_service,subscriber:d.call_fsm,event:a.failureEvent,msg:{callId:a.callId,error:b}})}),e.promise},f.handleSetLocalOffer=function(a){var b=a.msg.callId,c=g[b];f.setDescription({pc:c.pc,method:"setLocalDescription",callId:a.msg.callId,sdpType:"offer",sdp:c.localSdp,successEvent:e.set_local_offer_success,failureEvent:e.set_local_offer_failure})},f.handleSetLocalAnswer=function(a){var b=a.msg.callId,c=g[b];f.setDescription({pc:c.pc,method:"setLocalDescription",callId:a.msg.callId,sdpType:"answer",sdp:c.localSdp,successEvent:e.set_local_answer_success,failureEvent:e.set_local_answer_failure})},f.handleSetRemoteOffer=function(a){var b=a.msg.callId,c=g[b];f.setDescription({pc:c.pc,method:"setRemoteDescription",callId:a.msg.callId,sdpType:"offer",sdp:c.remoteSdp,successEvent:e.set_remote_offer_success,failureEvent:e.set_remote_offer_failure})},f.handleSetRemoteAnswer=function(a){var b,c=a.msg.callId,d=g[c];f.setDescription({pc:d.pc,method:"setRemoteDescription",callId:c,sdpType:"answer",sdp:a.msg.sdp,successEvent:e.set_remote_answer_success,failureEvent:e.set_remote_answer_failure}).then(function(){if(d.remoteteCandidateQueue){for(b in d.remoteteCandidateQueue)d.remoteteCandidateQueue.hasOwnProperty(b)&&f.handleIceCandidateNotify({msg:{callId:c,candidate:d.remoteteCandidateQueue[b]}});d.remoteteCandidateQueue=null}})},f.handleIceCandidateNotify=function(a){var b=a.msg.callId,c=g[b];return""===c.pc.remoteDescription.sdp?(c.remoteteCandidateQueue||(c.remoteteCandidateQueue=[]),void c.remoteteCandidateQueue.push(a.msg.candidate)):void c.pc.addIceCandidate(new RTCIceCandidate(a.msg.candidate),function(){},function(a){})},f.handleMuteUnmuteAudio=function(a){var b=a.msg.callId;g[b];g[a.msg.callId].pc.getLocalStreams()&&g[a.msg.callId].pc.getLocalStreams()[0]&&(g[a.msg.callId].pc.getLocalStreams()[0].getAudioTracks()[0].enabled=a.msg.mute)},h[e.create_peer]=f.handleCreatePeer,h[e.create_offer]=f.handleCreateOffer,h[e.create_answer]=f.handleCreateAnswer,h[e.set_local_offer]=f.handleSetLocalOffer,h[e.set_local_answer]=f.handleSetLocalAnswer,h[e.set_remote_offer]=f.handleSetRemoteOffer,h[e.set_remote_answer]=f.handleSetRemoteAnswer,h[e.add_local_stream]=f.handleAddLocalStream,h[e.ice_candidate_notify]=f.handleIceCandidateNotify,h[e.mute_unmute_audio]=f.handleMuteUnmuteAudio,f.handlePeerServiceEvent=function(a){h[a.event](a)},c.subscribe({subscriber:d.peer_service,callback:f.handlePeerServiceEvent}),c.subscribe({subscriber:d.global,event:e.clear_resources,callback:function(b){a.info("peer service: deleting call object: "+b.msg.callId),g[b.msg.callId].pc.onicecandidate=null,g[b.msg.callId].pc.oniceconnectionstatechange=null,g[b.msg.callId].pc.onaddstream=null,g[b.msg.callId].pc.getLocalStreams()&&g[b.msg.callId].pc.getLocalStreams()[0]&&(g[b.msg.callId].pc.getLocalStreams()[0].getTracks()[0].stop(),g[b.msg.callId].pc.getLocalStreams()[0].getTracks()[1].stop()),g[b.msg.callId].pc.close(),g[b.msg.callId].pc=null,delete g[b.msg.callId]}})}]).run(["peerService",function(){}]);
//# sourceMappingURL=sourcemap.map